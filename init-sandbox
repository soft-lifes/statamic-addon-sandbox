#!/usr/bin/env bash
set -euo pipefail

#
# Statamic Addon Sandbox Initializer
# Usage: ./init-sandbox <org/addon-name> [branch]
# Example: ./init-sandbox el-schneider/statamic-magic-actions v6
#

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() { echo -e "${BLUE}▸${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; exit 1; }

# Check arguments
if [[ $# -lt 1 ]]; then
    echo "Usage: ./init-sandbox <org/addon-name> [branch]"
    echo "Example: ./init-sandbox el-schneider/statamic-magic-actions v6"
    exit 1
fi

# Check Docker is available
if ! command -v docker &>/dev/null; then
    error "Docker is not installed or not in PATH"
fi

if ! docker info &>/dev/null; then
    error "Docker is not running or you don't have permission. Try: sudo usermod -aG docker \$USER && logout/login"
fi

ADDON_REPO="$1"
ADDON_BRANCH="${2:-main}"
ADDON_NAME=$(echo "$ADDON_REPO" | cut -d'/' -f2)
ADDON_VENDOR=$(echo "$ADDON_REPO" | cut -d'/' -f1)

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}     Statamic Addon Sandbox Initializer                      ${GREEN}║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
info "Addon: ${ADDON_REPO}"
info "Branch: ${ADDON_BRANCH}"
echo ""

# Step 1: Find available port
info "Finding available port..."
find_available_port() {
    local port=$1
    while lsof -i :$port &>/dev/null || docker ps --format '{{.Ports}}' 2>/dev/null | grep -q ":$port->"; do
        ((port++))
    done
    echo $port
}

APP_PORT=$(find_available_port 8100)
VITE_PORT=$(find_available_port 5173)
success "Using APP_PORT=${APP_PORT}, VITE_PORT=${VITE_PORT}"

# Step 2: Configure .env
info "Configuring .env..."
HOST_UID=$(id -u)
HOST_GID=$(id -g)

cat >> .env << EOF

# Sandbox Configuration (auto-generated by init-sandbox)
APP_PORT=${APP_PORT}
VITE_PORT=${VITE_PORT}

# Match host UID/GID to avoid permission issues
WWWUSER=${HOST_UID}
WWWGROUP=${HOST_GID}

# Enable Pro for multiple users
STATAMIC_PRO_ENABLED=true
EOF

success ".env configured"

# Step 3: Install Sail
info "Installing Laravel Sail..."
composer require laravel/sail --dev --quiet
php artisan sail:install --with=none --quiet 2>/dev/null || true
success "Sail installed"

# Step 4: Add addon as git submodule
info "Adding addon as git submodule..."
mkdir -p addons
if [[ -d "addons/${ADDON_NAME}" ]]; then
    warn "Addon directory already exists, skipping submodule"
else
    # Try with specified branch first, fall back to default branch
    if git submodule add -b "${ADDON_BRANCH}" "https://github.com/${ADDON_REPO}.git" "addons/${ADDON_NAME}" 2>/dev/null; then
        success "Submodule added: addons/${ADDON_NAME} (branch: ${ADDON_BRANCH})"
    elif git submodule add "https://github.com/${ADDON_REPO}.git" "addons/${ADDON_NAME}" 2>/dev/null; then
        warn "Branch '${ADDON_BRANCH}' not found, using default branch"
        success "Submodule added: addons/${ADDON_NAME}"
    else
        error "Failed to add submodule. Check that ${ADDON_REPO} exists on GitHub."
    fi
fi

# Step 5: Update composer.json with path repository
info "Configuring composer path repository..."

# Extract addon's composer name
ADDON_COMPOSER_NAME=$(grep -o '"name": *"[^"]*"' "addons/${ADDON_NAME}/composer.json" | head -1 | cut -d'"' -f4)
if [[ -z "$ADDON_COMPOSER_NAME" ]]; then
    ADDON_COMPOSER_NAME="${ADDON_VENDOR}/${ADDON_NAME}"
    warn "Could not detect composer name, using: ${ADDON_COMPOSER_NAME}"
fi

# Add repository to composer.json using PHP (more reliable than jq for this)
php -r "
\$json = json_decode(file_get_contents('composer.json'), true);
\$json['repositories'] = \$json['repositories'] ?? [];
\$exists = false;
foreach (\$json['repositories'] as \$repo) {
    if (isset(\$repo['url']) && \$repo['url'] === 'addons/${ADDON_NAME}') {
        \$exists = true;
        break;
    }
}
if (!\$exists) {
    \$json['repositories'][] = [
        'type' => 'path',
        'url' => 'addons/${ADDON_NAME}',
        'options' => ['symlink' => true]
    ];
}
file_put_contents('composer.json', json_encode(\$json, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . \"\n\");
"
success "Path repository configured"

# Step 6: Require the addon
info "Requiring addon: ${ADDON_COMPOSER_NAME}..."
composer require "${ADDON_COMPOSER_NAME}:@dev" --quiet
success "Addon installed"

# Step 7: Start Sail
info "Starting Sail containers..."
./vendor/bin/sail up -d --quiet 2>/dev/null || ./vendor/bin/sail up -d
sleep 3  # Wait for container to be ready
success "Sail started"

# Step 8: Fix storage permissions
info "Fixing storage permissions..."
./vendor/bin/sail root-shell -c "chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache" 2>/dev/null || \
    docker compose exec -T laravel.test chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache
success "Permissions fixed"

# Step 9: Clear and warm stache
info "Warming the Stache..."
./vendor/bin/sail artisan statamic:stache:clear --quiet 2>/dev/null || true
./vendor/bin/sail artisan statamic:stache:warm --quiet 2>/dev/null || \
    ./vendor/bin/sail artisan statamic:stache:warm
success "Stache warmed"

# Step 10: Create stub manifest if addon has assets
if [[ -f "addons/${ADDON_NAME}/vite.config.js" ]] || [[ -f "addons/${ADDON_NAME}/webpack.mix.js" ]]; then
    info "Creating asset stub manifest..."
    MANIFEST_DIR="public/vendor/${ADDON_NAME}/build"
    mkdir -p "${MANIFEST_DIR}"
    echo '{}' > "${MANIFEST_DIR}/manifest.json"
    success "Stub manifest created"
fi

# Done!
echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}     Sandbox Ready!                                          ${GREEN}║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  ${BLUE}URL:${NC}      http://localhost:${APP_PORT}/cp"
echo -e "  ${BLUE}Email:${NC}    test@sandbox.test"
echo -e "  ${BLUE}Password:${NC} sandbox123"
echo ""
echo -e "  ${BLUE}Addon:${NC}    addons/${ADDON_NAME}/"
echo -e "  ${BLUE}Sail:${NC}     ./vendor/bin/sail [up|down|artisan|shell]"
echo ""
