#!/usr/bin/env bash
set -euo pipefail

#
# Statamic Addon Sandbox Initializer
# Usage: ./init-sandbox <org/addon-name> [branch]
# Example: ./init-sandbox el-schneider/statamic-magic-actions v6
#

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

info() { echo -e "${BLUE}▸${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; exit 1; }

usage() {
    echo "Usage: ./init-sandbox <org/addon-name> [branch]"
    echo "Example: ./init-sandbox el-schneider/statamic-magic-actions v6"
}

require_cmd() {
    local cmd="$1"
    local hint="${2:-}"

    if ! command -v "$cmd" &>/dev/null; then
        if [[ -n "$hint" ]]; then
            error "$cmd is not installed or not in PATH. $hint"
        fi
        error "$cmd is not installed or not in PATH"
    fi
}

preflight_checks() {
    info "Running preflight checks..."

    require_cmd docker "Install Docker Desktop / Docker Engine first."
    require_cmd git
    require_cmd php "Install PHP CLI (used for sail:install and composer.json updates)."
    require_cmd composer "Install Composer (used during sandbox setup)."

    if ! docker info &>/dev/null; then
        error "Docker is not running or you don't have permission. Try: sudo usermod -aG docker \$USER && logout/login"
    fi

    if ! git rev-parse --is-inside-work-tree &>/dev/null; then
        error "Current directory is not a git repository. Recreate with --git, or run 'git init' before init-sandbox."
    fi

    success "Preflight checks passed"
}

port_in_use() {
    local port="$1"
    # Check host ports (ss is ubiquitous on modern Linux; lsof as fallback)
    if command -v ss &>/dev/null; then
        ss -tlnH "sport = :$port" 2>/dev/null | grep -q .
    elif command -v lsof &>/dev/null; then
        lsof -i :"$port" &>/dev/null
    else
        # Can't check — assume free
        return 1
    fi
}

find_available_port() {
    local port="$1"
    while port_in_use "$port" || docker ps --format '{{.Ports}}' 2>/dev/null | grep -q ":$port->"; do
        ((port++))
    done
    echo "$port"
}

set_env_key() {
    local key="$1"
    local value="$2"

    if [[ ! -f .env ]]; then
        if [[ -f .env.example ]]; then
            cp .env.example .env
        else
            touch .env
        fi
    fi

    if grep -q "^${key}=" .env; then
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "s|^${key}=.*|${key}=${value}|" .env
        else
            sed -i "s|^${key}=.*|${key}=${value}|" .env
        fi
    else
        echo "${key}=${value}" >> .env
    fi
}

addon_display_name() {
    # "statamic-auto-alt-text" → "Auto Alt Text"
    echo "$1" | sed 's/^statamic-//' | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g'
}

configure_env() {
    info "Configuring .env..."

    APP_PORT=$(find_available_port 8100)
    VITE_PORT=$(find_available_port 5173)
    HOST_UID=$(id -u)
    HOST_GID=$(id -g)

    DISPLAY_NAME=$(addon_display_name "${ADDON_NAME}")

    set_env_key APP_PORT "$APP_PORT"
    set_env_key VITE_PORT "$VITE_PORT"
    set_env_key WWWUSER "$HOST_UID"
    set_env_key WWWGROUP "$HOST_GID"
    set_env_key STATAMIC_PRO_ENABLED true
    set_env_key APP_NAME "\"${DISPLAY_NAME} Sandbox\""
    set_env_key STATAMIC_CUSTOM_LOGO_TEXT "\"${DISPLAY_NAME}\""

    success ".env configured (APP_PORT=${APP_PORT}, VITE_PORT=${VITE_PORT})"
    success "Branding: ${DISPLAY_NAME}"
}

install_sail() {
    info "Installing Laravel Sail..."

    composer require laravel/sail --dev --quiet --ignore-platform-reqs --no-scripts

    if ! php artisan sail:install --with=none --quiet 2>/dev/null; then
        warn "sail:install failed (usually missing host PHP extensions), using fallback compose.yaml"
        cp "${SCRIPT_DIR}/stubs/compose.sail.yaml" compose.yaml
    fi

    success "Sail installed"
}

clone_addon() {
    info "Cloning addon into addons/..."

    mkdir -p addons

    if [[ -d "addons/${ADDON_NAME}" ]]; then
        warn "Addon directory already exists, skipping clone"
        return
    fi

    if git clone -b "${ADDON_BRANCH}" "https://github.com/${ADDON_REPO}.git" "addons/${ADDON_NAME}" 2>/dev/null; then
        success "Cloned: addons/${ADDON_NAME} (branch: ${ADDON_BRANCH})"
    elif git clone "https://github.com/${ADDON_REPO}.git" "addons/${ADDON_NAME}" 2>/dev/null; then
        warn "Branch '${ADDON_BRANCH}' not found, using default branch"
        success "Cloned: addons/${ADDON_NAME}"
    else
        error "Failed to clone. Check that ${ADDON_REPO} exists on GitHub."
    fi

    # Ensure addons/ is gitignored in the sandbox
    if ! grep -qxF 'addons/' .gitignore 2>/dev/null; then
        echo 'addons/' >> .gitignore
        success "Added addons/ to .gitignore"
    fi
}

detect_addon_composer_name() {
    ADDON_COMPOSER_NAME=$(grep -o '"name": *"[^"]*"' "addons/${ADDON_NAME}/composer.json" | head -1 | cut -d'"' -f4)

    if [[ -z "$ADDON_COMPOSER_NAME" ]]; then
        ADDON_COMPOSER_NAME="${ADDON_VENDOR}/${ADDON_NAME}"
        warn "Could not detect composer name, using: ${ADDON_COMPOSER_NAME}"
    fi
}

configure_composer_path_repository() {
    info "Configuring composer path repository..."

    php -r "
\$json = json_decode(file_get_contents('composer.json'), true);
\$json['repositories'] = \$json['repositories'] ?? [];
\$exists = false;
foreach (\$json['repositories'] as \$repo) {
    if (isset(\$repo['url']) && \$repo['url'] === 'addons/${ADDON_NAME}') {
        \$exists = true;
        break;
    }
}
if (!\$exists) {
    \$json['repositories'][] = [
        'type' => 'path',
        'url' => 'addons/${ADDON_NAME}',
        'options' => ['symlink' => true]
    ];
}
file_put_contents('composer.json', json_encode(\$json, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . \"\\n\");
"

    success "Path repository configured"
}

require_addon() {
    info "Requiring addon: ${ADDON_COMPOSER_NAME}..."
    composer require "${ADDON_COMPOSER_NAME}:@dev" --quiet --ignore-platform-reqs --no-scripts --no-interaction
    success "Addon installed"
}

start_sail() {
    info "Starting Sail containers..."
    ./vendor/bin/sail up -d --quiet 2>/dev/null || ./vendor/bin/sail up -d
    sleep 3
    success "Sail started"
}

post_start_setup() {
    info "Fixing storage permissions..."
    ./vendor/bin/sail root-shell -c "chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache" 2>/dev/null || \
        docker compose exec -T laravel.test chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache
    success "Permissions fixed"

    info "Generating application key..."
    ./vendor/bin/sail artisan key:generate --quiet 2>/dev/null || \
        docker compose exec -T laravel.test php artisan key:generate --quiet
    success "App key generated"

    info "Running Statamic install..."
    ./vendor/bin/sail artisan statamic:install --no-interaction --quiet 2>/dev/null || \
        docker compose exec -T laravel.test php artisan statamic:install --no-interaction --quiet
    success "Statamic installed"

    info "Discovering addons..."
    ./vendor/bin/sail artisan statamic:addons:discover --quiet 2>/dev/null || \
        docker compose exec -T laravel.test php artisan statamic:addons:discover --quiet
    success "Addons discovered"

    info "Warming the Stache..."
    ./vendor/bin/sail artisan statamic:stache:clear --quiet 2>/dev/null || true
    ./vendor/bin/sail artisan statamic:stache:warm --quiet 2>/dev/null || \
        ./vendor/bin/sail artisan statamic:stache:warm
    success "Stache warmed"
}

publish_addon_assets() {
    # If the addon ships pre-built assets, copy them to the public directory.
    # This avoids the "Vite manifest not found" error without needing npm/build.
    local dist_dir="addons/${ADDON_NAME}/resources/dist/build"
    local target_dir="public/vendor/${ADDON_NAME}/build"

    if [[ -d "$dist_dir" && -f "$dist_dir/manifest.json" ]]; then
        info "Publishing pre-built addon assets..."
        mkdir -p "${target_dir}"
        cp -r "${dist_dir}/"* "${target_dir}/"
        success "Addon assets published"
    elif [[ -f "addons/${ADDON_NAME}/vite.config.js" ]] || [[ -f "addons/${ADDON_NAME}/webpack.mix.js" ]]; then
        info "Creating asset stub manifest..."
        mkdir -p "${target_dir}"
        echo '{}' > "${target_dir}/manifest.json"
        warn "Addon has build config but no pre-built assets — stub manifest created"
    fi
}

# ---- main ----

if [[ $# -lt 1 ]]; then
    usage
    exit 1
fi

ADDON_REPO="$1"
ADDON_BRANCH="${2:-main}"

if [[ "$ADDON_REPO" != */* ]]; then
    error "Invalid addon format '${ADDON_REPO}'. Expected org/addon-name"
fi

ADDON_NAME=$(echo "$ADDON_REPO" | cut -d'/' -f2)
ADDON_VENDOR=$(echo "$ADDON_REPO" | cut -d'/' -f1)

preflight_checks

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}     Statamic Addon Sandbox Initializer                      ${GREEN}║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
info "Addon: ${ADDON_REPO}"
info "Branch: ${ADDON_BRANCH}"
echo ""

configure_env
clone_addon
install_sail
detect_addon_composer_name
configure_composer_path_repository
require_addon
start_sail
post_start_setup
publish_addon_assets

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${NC}     Sandbox Ready!                                          ${GREEN}║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""
HOSTNAME=$(hostname 2>/dev/null || echo "localhost")
echo -e "  ${BLUE}URL:${NC}      http://localhost:${APP_PORT}/cp"
if [[ "$HOSTNAME" != "localhost" ]]; then
    echo -e "  ${BLUE}Tailscale:${NC} http://${HOSTNAME}:${APP_PORT}/cp"
fi
echo -e "  ${BLUE}Email:${NC}    test@sandbox.test"
echo -e "  ${BLUE}Password:${NC} sandbox123"
echo ""
echo -e "  ${BLUE}Addon:${NC}    addons/${ADDON_NAME}/"
echo -e "  ${BLUE}Brand:${NC}    ${DISPLAY_NAME}"
echo -e "  ${BLUE}Sail:${NC}     ./vendor/bin/sail [up|down|artisan|shell]"
echo ""
